<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panská 17 | Property Manager</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background-color: #f8fafc;
  color: #0f172a;
  overflow-x: hidden;
}

.hidden { display: none !important; }
.nav-active { background-color:#f1f5f9; color:#2563eb; border-left:4px solid #2563eb; font-weight:800; }
.modal-bg { background:rgba(15,23,42,.6); backdrop-filter:blur(8px); }
.mobile-menu-open { transform:translateX(0)!important; }

/* COMPACT MODE */
body.compact main { padding: 1rem !important; }
body.compact .card { border-radius: 1rem !important; }
body.compact .card-pad { padding: 1rem !important; }
body.compact .section-gap { gap:.75rem !important; }
body.compact .h-page { font-size:1.5rem!important; }
body.compact .h-floor { font-size:1rem!important; }
body.compact .btn { padding:.35rem .6rem!important; border-radius:.6rem!important; }
body.compact .issue { padding:.5rem .6rem!important; border-radius:.6rem!important; }
body.compact .logrow { padding:.3rem 0!important; }

@media print {
  aside,nav,button,.no-print { display:none!important; }
  main { margin:0!important;padding:0!important;width:100%!important; }
}
</style>
</head>

<body>

<div class="md:hidden flex items-center justify-between p-4 bg-white border-b">
  <button onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
  <strong>Panská 17</strong>
  <div></div>
</div>

<div class="min-h-screen flex">
<aside id="sidebar" class="fixed md:relative inset-y-0 left-0 w-64 bg-white border-r transform -translate-x-full md:translate-x-0 transition">
  <div class="p-6 border-b font-black text-xl">Panská 17</div>
  <nav class="py-4">
    <button onclick="switchView('dash')" id="n-dash" class="w-full px-6 py-3 text-left uppercase text-xs">Dashboard</button>
    <button onclick="switchView('insp')" id="n-insp" class="w-full px-6 py-3 text-left uppercase text-xs">Obhliadka BR</button>
    <button onclick="switchView('rep')" id="n-rep" class="w-full px-6 py-3 text-left uppercase text-xs">Report</button>
    <button onclick="switchView('arch')" id="n-arch" class="w-full px-6 py-3 text-left uppercase text-xs">Archív</button>
  </nav>
</aside>

<main class="flex-1 p-6 md:p-10 overflow-y-auto">

<!-- DASHBOARD -->
<div id="v-dash">
<h2 class="h-page text-3xl font-black uppercase mb-6">Dashboard</h2>
<div class="grid grid-cols-2 gap-4">
  <div class="card card-pad bg-white border shadow-sm">
    <div class="text-xs uppercase">Aktívne</div>
    <div id="s-open" class="text-4xl font-black">--</div>
  </div>
  <div class="card card-pad bg-white border shadow-sm">
    <div class="text-xs uppercase">Vybavené</div>
    <div id="s-done" class="text-4xl font-black">--</div>
  </div>
</div>
</div>

<!-- INSPECTION -->
<div id="v-insp" class="hidden">
<div class="flex flex-wrap items-end justify-between mb-4 border-b pb-4">
  <h2 class="h-page text-3xl font-black uppercase">Obhliadka BR</h2>
  <div class="flex gap-2">
    <input id="att-all" placeholder="Prítomní" class="border rounded px-2 py-1 text-xs">
    <button onclick="toggleDensity()" class="btn border text-xs uppercase">Compact</button>
  </div>
</div>
<div id="section-container" class="space-y-6"></div>
</div>

<!-- ARCHIVE -->
<div id="v-arch" class="hidden">
<h2 class="text-xl font-black uppercase mb-4">Archív</h2>
<div id="archive-container" class="space-y-2"></div>
</div>

<!-- REPORT -->
<div id="v-rep" class="hidden">
<h2 class="text-xl font-black uppercase mb-4">Report</h2>
<button onclick="window.print()" class="btn bg-slate-900 text-white mb-4">Tlačiť</button>
<div id="rep-list"></div>
</div>

</main>
</div>

<script>
const sb = supabase.createClient(
'https://tyimhlqtncjynutxihrf.supabase.co',
'sb_publishable_jX6gFj0WZfxXFNpwF1bTuw_dQADscTW'
);

let allLocs=[],allUpdates=[];

function toggleMenu(){document.getElementById('sidebar').classList.toggle('mobile-menu-open')}
function toggleDensity(){
  document.body.classList.toggle('compact');
  localStorage.setItem('density',document.body.classList.contains('compact')?'compact':'comfort');
}
if(localStorage.getItem('density')==='compact')document.body.classList.add('compact');

function switchView(v){
['dash','insp','arch','rep'].forEach(x=>{
  document.getElementById('v-'+x).classList.add('hidden');
  document.getElementById('n-'+x).classList.remove('nav-active');
});
document.getElementById('v-'+v).classList.remove('hidden');
document.getElementById('n-'+v).classList.add('nav-active');
if(v==='insp')loadSections();
if(v==='dash')loadDash();
if(v==='arch')loadArchive();
}

async function loadDash(){
const {count:o}=await sb.from('issues').select('*',{count:'exact',head:true}).eq('archived',false);
document.getElementById('s-open').innerText=o||0;
document.getElementById('s-done').innerText='—';
}

async function loadSections(){
const cont=document.getElementById('section-container');
cont.innerHTML='Načítavam…';

const {data:locs}=await sb.from('locations').select('*').order('sort_order');
const {data:iss}=await sb.from('issues').select('*,locations(*)').eq('archived',false);
const {data:upd}=await sb.from('issue_updates').select('*').order('event_date',{ascending:false});

allLocs=locs; allUpdates=upd;
cont.innerHTML='';

[...new Set(locs.map(l=>l.floor))].forEach(f=>{
const fLocs=locs.filter(l=>l.floor===f);
const fIss=iss.filter(i=>fLocs.some(l=>l.id===i.location_id));

const box=document.createElement('div');
box.className='card card-pad bg-white border shadow-sm section-gap space-y-2';

box.innerHTML=`
<div class="flex justify-between items-center border-b pb-2">
<h3 class="h-floor font-black uppercase">${f}</h3>
<button class="btn bg-slate-900 text-white">+ Pridať</button>
</div>
${fIss.map(i=>{
const logs=upd.filter(u=>u.issue_id===i.id);
return`
<div class="issue border">
<div class="flex justify-between items-start gap-2">
<div class="min-w-0">
<div class="text-xs font-bold truncate">${i.title}</div>
<div class="text-[10px] text-slate-500">${i.responsible_person||'--'}</div>
</div>
<button class="btn text-xs border">✏️</button>
</div>
<details class="mt-1">
<summary class="text-[10px] uppercase cursor-pointer">História (${logs.length})</summary>
${logs.map(u=>`
<div class="logrow flex gap-2 text-xs">
<span class="text-slate-400">${u.event_date?.split('T')[0]}</span>
<span>${u.note||''}</span>
</div>`).join('')}
</details>
</div>`}).join('')}
`;
cont.appendChild(box);
});
}

async function loadArchive(){
const {data:a}=await sb.from('issues').select('*').eq('archived',true);
document.getElementById('archive-container').innerHTML=
a.map(i=>`<div class="border p-2 text-xs">${i.title}</div>`).join('');
}

switchView('dash');
</script>

</body>
</html>
